<!--
 alobexpress-setup (c) by Jonatan Renan
 
 alobexpress-setup is licensed under a
 Creative Commons Attribution 4.0 International License.
 
 You should have received a copy of the license along with this
 work. If not, see <https://creativecommons.org/licenses/by/4.0/>.
-->

<p align="center">
  <a href="" rel="noopener">
 <img width=200px height=200px src="https://i.imgur.com/FxL5qM0.jpg" alt="Bot logo"></a>
</p>

<h2 align="center">ALOB EXPRESS SETUP</h2>
<h3 align="center">N8N + Evolution API + Supabase + Portainer + Traefik + S3</h3>

<div align="center">

[![Status](https://img.shields.io/badge/status-active-success.svg)]()
[![Platform](https://img.shields.io/badge/platform-reddit-orange.svg)](https://www.reddit.com/user/Wordbook_Bot)
[![GitHub Issues](https://img.shields.io/github/issues/renanvt/The-Documentation-Compendium.svg)](https://github.com/renanvt/The-Documentation-Compendium/issues)
[![GitHub Pull Requests](https://img.shields.io/github/issues-pr/renanvt/The-Documentation-Compendium.svg)](https://github.com/renanvt/The-Documentation-Compendium/pulls)
[![License](https://img.shields.io/badge/license-MIT-blue.svg)](/LICENSE)

</div>

---

<p align="center"> ü§ñ Few lines describing what your bot does.
    <br> 
</p>


# T√≥picos

[Como Usar o Script](#-como-usar-o-script)

[Porque Free Tier?](#porque-free-tier)

[Proje√ß√£o de custos reais](#-proje√ß√£o-de-custos-real)

[Criar Bucket S3 para AlobExpress](#criar-bucket-s3-para-alobexpress)

[Criar a inst√¢ncia EC2](#criar-a-inst√¢ncia-ec2)

[Otimiza√ß√µes para Maximizar o tempo](#-otimiza√ß√µes-para-maximizar-o-tempo)


[Testes](#-teste-completo-de-uploaddownload)

[Atualizar o .env do Projeto](#-atualizar-o-env-do-projeto)

[Verificar se Evolution API Est√° Usando S3](#-verificar-se-evolution-api-est√°-usando-s3)

[Configurar CORS (para Evolution API)](#Ô∏è-configurar-cors-para-evolution-api)

[Problemas Comuns](#-problemas-comuns)

[Viabilidade para N8N em Produ√ß√£o](#-viabilidade-para-n8n-em-produ√ß√£o)



üîç Principais Diferen√ßas da Vers√£o Anterior

![Diferen√ßa Vers√µes](/img/5.PNG)

# üìù Como Usar o Script 

## 1. Fazer upload do script para a EC2

```bash
scp setup_alobexpress_v2.sh ubuntu@seu-ip-ec2:/home/ubuntu/
```
## 2. Conectar na EC21

```bash
ssh ubuntu@seu-ip-ec2
```

## 3. Dar permiss√£o de execu√ß√£o

```bash
chmod +x setup_alobexpress_v2.sh
```
## 4. Executar como root

```bash
sudo ./setup_alobexpress_v2.sh
```

---

## üé® Exemplo de Sa√≠da Visual

```bash
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë  üöÄ ALOBEXPRESS INFRASTRUCTURE SETUP v2.0.1                   ‚ïë
‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£
‚ïë  Configura√ß√£o automatizada para EC2 + Docker + Traefik        ‚ïë
‚ïë  Servidor: EC2 t3.small Ubuntu 22.04                          ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù

‚ñ∂ VALIDANDO CREDENCIAIS AWS
  ‚úì Credenciais AWS v√°lidas
  ‚úì Acesso ao bucket S3 confirmado

‚ñ∂ CRIANDO ESTRUTURA DE PASTAS NO S3
  ‚úì Pasta criada: evolution/
  ‚úì Pasta criada: backups/n8n/

Nome: alobexpress-production
```


**Tags recomendadas:**
- `Name`: alobexpress-production
- `Environment`: production
- `Project`: alobexpress
- `ManagedBy`: terraform (opcional)

---


# Porque Free Tier?

## üéÅ Free Tier - Primeiro Ano (12 meses)
Conforme a imagem, voc√™ tem direito a:
‚úÖ 750 horas/m√™s de t3.small (equivale a 1 inst√¢ncia 24/7)
‚úÖ 30GB EBS gp2/gp3
‚úÖ 5GB S3 Standard
‚úÖ 100GB Data Transfer OUT

Custos REAIS no Free Tier (primeiros 12 meses):
![Custos Reais no Free Tier](/img/2.PNG)


## üí∞ An√°lise Detalhada de Custos (N. Virginia - us-east-1)

üìä Breakdown de Custos Mensais
![Breakdown de Custos Mensais](/img/1.PNG)

**Por que t3.small?**
- ‚úÖ 2 GB RAM (m√≠nimo para Evolution + N8N + Postgres + Redis)
- ‚úÖ 2 vCPUs (melhor performance)
- ‚úÖ Cr√©ditos de CPU balanceados
- ‚ö†Ô∏è **t2.micro** (Free Tier) **N√ÉO √© recomendado** - RAM insuficiente


## ‚è∞ Quanto Tempo Durar√° Seu Cr√©dito? Exemplo: $119.20

Cen√°rio 1: Primeiros 12 Meses (Free Tier Ativo)


Custo mensal: $1.54
Dura√ß√£o: $119.20 √∑ $1.54 = 77 meses (6+ anos!)

```bash
‚úÖ **Seu cr√©dito durar√° TODO o Free Tier e sobrar√° ~$100!**
```

## **Cen√°rio 2: Ap√≥s Free Tier (m√™s 13+)**
```bash
Custo mensal: $19.23
Cr√©dito restante: ~$100
Dura√ß√£o extra: $100 √∑ $19.23 = 5.2 meses
---

‚úÖ Total: 12 meses (Free) + 5 meses (pago) = ~17 meses!
```

# üìà Proje√ß√£o de Custos Real

![Proje√ß√£o de Custo Real](/img/3.PNG)

### üõ°Ô∏è Plano B: Se Estourar o Or√ßamento

#### Op√ß√£o 1: Migrar para Spot Instance

```bash
# t3.small spot = $0.0062/h (~$4.50/m√™s)
# Economia: 70%
```

#### Op√ß√£o 2: Downgrade para t3.micro

```bash
# 1 vCPU, 1GB RAM = $7.59/m√™s
# Economia: 50%
# ‚ö†Ô∏è S√≥ para testes, n√£o produ√ß√£o
```

# Criar Bucket S3 para AlobExpress

Para que o script funcione de maneira correta, voc√™ precisa criar um Bucket no S3 da sua AWS

## üìã Passo 1: Criar o Bucket

Pelo Console AWS:

Acesse: https://s3.console.aws.amazon.com/s3/
Clique em "Create bucket"
Preencha conforme abaixo:

### ‚öôÔ∏è Configura√ß√µes Recomendadas

![Buckecket](/img/0.PNG)

## üîπ Passo 2: Object Ownership

```bash
‚úÖ ACLs disabled (recommended)
```
- Voc√™ ser√° o √∫nico dono dos objetos
- Evolution API gravar√° com suas credenciais IAM

---

### **üîπ Block Public Access**

```bash
‚úÖ Block all public access
  ‚úÖ Block public access to buckets and objects granted through new ACLs
  ‚úÖ Block public access to buckets and objects granted through any ACLs
  ‚úÖ Block public access to buckets and objects granted through new public bucket or access point policies
  ‚úÖ Block public and cross-account access to buckets and objects through any public bucket or access point policies
```

‚ö†Ô∏è **IMPORTANTE:** Manter tudo bloqueado! Evolution API acessa via credenciais, n√£o precisa ser p√∫blico.

---

### **üîπ Bucket Versioning**

```bash
‚ö™ Disable (para economizar)
```

**Por qu√™?**
- Versioning duplica custos (cada vers√£o conta como arquivo)
- Para backups, usaremos datas nos nomes
- Se quiser recupera√ß√£o de arquivos deletados: ative s√≥ depois

---

### **üîπ Default Encryption**

```bash
‚úÖ Server-side encryption with Amazon S3 managed keys (SSE-S3)
  ‚ö™ Bucket Key: Enabled
```

**Benef√≠cios:**
- Criptografia autom√°tica (gr√°tis)
- Reduz custos de requisi√ß√µes KMS em 99%

---

### **üîπ Advanced Settings**

```bash
‚ö™ Object Lock: Disabled
```



# Criar a inst√¢ncia EC2

## üêß **PASSO 3: Escolher Sistema Operacional**

### ‚ö†Ô∏è **CR√çTICO: Escolha EXATAMENTE esta imagem**

**Application and OS Images (Amazon Machine Image)**
```bash
üîç Buscar: Ubuntu Server 22.04 LTS
```

Selecione:

```bash
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Ubuntu Server 22.04 LTS (HVM)          ‚îÇ
‚îÇ SSD Volume Type                         ‚îÇ
‚îÇ Architecture: 64-bit (x86)              ‚îÇ
‚îÇ ‚úÖ Free tier eligible                   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**Especifica√ß√µes:**
- **Nome**: Ubuntu Server 22.04 LTS
- **Arquitetura**: 64-bit (x86) - **N√ÉO escolha ARM**
- **Root device type**: EBS
- **Virtualization**: HVM

---

## üíª **PASSO 4: Tipo de Inst√¢ncia**

### Escolha: **t3.small**

```bash
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Instance Type: t3.small                              ‚îÇ
‚îÇ                                                      ‚îÇ
‚îÇ vCPUs: 2                                            ‚îÇ
‚îÇ Memory: 2 GiB                                       ‚îÇ
‚îÇ Network Performance: Up to 5 Gigabit                ‚îÇ
‚îÇ                                                      ‚îÇ
‚îÇ ‚ö†Ô∏è N√ÉO √© Free Tier                                  ‚îÇ
‚îÇ Custo aproximado: ~$15-20/m√™s                       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```


## üîë **PASSO 5: Key Pair (Par de Chaves)**

### Op√ß√£o A: Criar Nova Chave

```bash
1. Clique em "Create new key pair"
2. Nome: alobexpress-key
3. Key pair type: RSA
4. Private key format: .pem (para Linux/Mac) ou .ppk (para Windows/PuTTY)
5. Clique em "Create key pair"
6. ‚ö†Ô∏è SALVE O ARQUIVO .pem EM LOCAL SEGURO
```

### Op√ß√£o B: Usar Chave Existente

```bash
Selecione uma chave SSH que voc√™ j√° possui
```

**‚ö†Ô∏è IMPORTANTE:** Guarde o arquivo `.pem` com seguran√ßa! Voc√™ precisar√° dele para conectar via SSH.

---

## üîí **PASSO 6: Network Settings (CR√çTICO)**

### 6.1 **Criar Security Group**

```bash
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ ‚úÖ Create security group                            ‚îÇ
‚îÇ                                                     ‚îÇ
‚îÇ Security group name: alobexpress-sg                ‚îÇ
‚îÇ Description: Security group for AlobExpress        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### 6.2 **Configurar Regras de Firewall**

#### **Regra 1: SSH (22)** - Para voc√™ acessar

```bash
Type: SSH
Protocol: TCP
Port: 22
Source: My IP (seu IP atual) ‚úÖ RECOMENDADO
   OU
Source: 0.0.0.0/0 (qualquer IP) ‚ö†Ô∏è MENOS SEGURO
```

#### **Regra 2: HTTP (80)** - Redirecionamento HTTPS

```bash
Type: HTTP
Protocol: TCP
Port: 80
Source: 0.0.0.0/0 (Anywhere IPv4) ‚úÖ OBRIGAT√ìRIO
```

#### **Regra 3: HTTPS (443)** - Acesso aos servi√ßos

```bash
Type: HTTPS
Protocol: TCP
Port: 443
Source: 0.0.0.0/0 (Anywhere IPv4) ‚úÖ OBRIGAT√ìRIO
```

### 6.3 **Resumo das Regras**

| Tipo | Protocolo | Porta | Origem | Descri√ß√£o |
|------|-----------|-------|--------|-----------|
| SSH | TCP | 22 | Seu IP | Acesso administrativo |
| HTTP | TCP | 80 | 0.0.0.0/0 | Redirecionamento para HTTPS |
| HTTPS | TCP | 443 | 0.0.0.0/0 | Portainer, N8N, Evolution |

---

## üíæ **PASSO 7: Configurar Armazenamento**

### Configura√ß√£o Recomendada:

```bash
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Volume 1 (Root Volume)                            ‚îÇ
‚îÇ                                                    ‚îÇ
‚îÇ Size: 30 GiB (m√≠nimo recomendado)                ‚îÇ
‚îÇ Volume Type: gp3 (melhor custo-benef√≠cio)        ‚îÇ
‚îÇ IOPS: 3000 (padr√£o)                               ‚îÇ
‚îÇ Throughput: 125 MB/s (padr√£o)                     ‚îÇ
‚îÇ                                                    ‚îÇ
‚îÇ ‚úÖ Delete on Termination: Yes                     ‚îÇ
‚îÇ ‚úÖ Encrypted: No (opcional)                       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## üîß **PASSO 8: Advanced Details (Opcional, mas Recomendado)**

### User Data (Script de Inicializa√ß√£o)

```bash
#!/bin/bash
# Atualizar sistema na primeira inicializa√ß√£o
apt-get update -y
apt-get upgrade -y

# Configurar timezone
timedatectl set-timezone America/Sao_Paulo

# Criar usu√°rio de deploy (opcional)
# useradd -m -s /bin/bash deploy
# usermod -aG sudo deploy
```

---

## üìä **PASSO 9: Resumo e Lan√ßamento**

### Revise as Configura√ß√µes:

```bash
‚úÖ Inst√¢ncia: Ubuntu Server 22.04 LTS
‚úÖ Tipo: t3.small (2 vCPU, 2 GB RAM)
‚úÖ Armazenamento: 30 GB gp3
‚úÖ Security Group: Portas 22, 80, 443 abertas
‚úÖ Key Pair: Criado e salvo
```

### Clique em **"Launch Instance"**

---

## üéØ **PASSO 10: Ap√≥s Lan√ßamento**

### 10.1 **Aguardar Inicializa√ß√£o**

```bash
Status: Pending ‚Üí Running (aguarde 2-3 minutos)
Status Checks: 2/2 checks passed
```

### 10.2 **Alocar IP El√°stico (OBRIGAT√ìRIO)**

**Por qu√™?** O IP p√∫blico muda a cada reinicializa√ß√£o. IP el√°stico √© fixo e **GRATUITO** enquanto estiver associado.

```bash
1. No menu lateral: Network & Security ‚Üí Elastic IPs
2. Clique em "Allocate Elastic IP address"
3. Clique em "Allocate"
4. Selecione o IP criado ‚Üí Actions ‚Üí Associate Elastic IP address
5. Instance: Selecione sua inst√¢ncia alobexpress-production
6. Clique em "Associate"
```

### 10.3 **Copiar IP P√∫blico/El√°stico**

```bash
Exemplo: 54.123.45.67
```

---

## üåê **PASSO 11: Configurar DNS (ANTES de rodar o script)**

Aponte seus dom√≠nios para o **IP El√°stico** da EC2:

### No seu provedor de DNS (ex: Registro.br, Cloudflare, Route53):
```bash
Tipo A:
portainer.seudominio.com.br  ‚Üí  54.123.45.67
n8n.seudominio.com.br        ‚Üí  54.123.45.67
evolution.seudominio.com.br  ‚Üí  54.123.45.67
```

## üåê **PASSO 12: Adicionar Permiss√µes IAM  (ANTES de rodar o script)**

V√° ao Console AWS e configure:
IAM ‚Üí Usu√°rios ‚Üí Seu usu√°rio ‚Üí Permiss√µes

Adicione esta pol√≠tica (inline policy):

```bash
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Action": [
                "s3:PutObject",
                "s3:GetObject",
                "s3:DeleteObject",
                "s3:ListBucket",
                "s3:GetBucketLocation",
                "s3:PutObjectAcl"
            ],
            "Resource": [
                "arn:aws:s3:::SEU_BUCKET_NAME",
                "arn:aws:s3:::SEU_BUCKET_NAME/*"
            ]
        }
    ]
}
```
> ‚ö†Ô∏è SUBSTITUA SEU_BUCKET_NAME pelo nome real do seu bucket!

# üîß Otimiza√ß√µes para Maximizar o Tempo



## 1. Reduzir Custos de S3 ($1.04/m√™s ‚Üí $0.30/m√™s)

Configurar Lifecycle Policy (ECONOMIA!)

1. Acesse o bucket criado
2. Aba Management ‚Üí Create lifecycle rule

![Lifecycle Policy](/img/4.PNG)

```bash
# Adicionar lifecycle policy no S3
aws s3api put-bucket-lifecycle-configuration \
  --bucket seu-bucket \
  --lifecycle-configuration '{
    "Rules": [{
      "Id": "DeleteOldMedia",
      "Status": "Enabled",
      "Filter": {"Prefix": "evolution/"},
      "Transitions": [{
        "Days": 30,
        "StorageClass": "GLACIER_IR"
      }],
      "Expiration": {"Days": 90}
    }]
  }'
```
> Economia: Arquivos antigos v√£o para Glacier ($0.004/GB) ou s√£o deletados ap√≥s 90 dias.

***Transitions:**

After 30 days ‚Üí Move to Glacier Instant Retrieval ($0.004/GB)
After 90 days ‚Üí Permanently delete

Economia estimada: $1.04/m√™s ‚Üí $0.35/m√™s (~66% de redu√ß√£o!)


## 2. Otimizar N8N para Poupar RAM

Adicione ao docker-compose.yml:

```bash
n8n:
  environment:
    # Limitar workers
    - EXECUTIONS_PROCESS=main
    - N8N_PAYLOAD_SIZE_MAX=16
    
    # Limpar execu√ß√µes antigas
    - EXECUTIONS_DATA_PRUNE=true
    - EXECUTIONS_DATA_MAX_AGE=72  # 3 dias (era 7)
    - EXECUTIONS_DATA_SAVE_ON_ERROR=always
    - EXECUTIONS_DATA_SAVE_ON_SUCCESS=none  # N√£o salvar sucessos
    
  deploy:
    resources:
      limits:
        memory: 800M  # Limite de RAM
```
> Ganho: N8N usar√° max 800MB, deixando RAM para outros servi√ßos.

## 3. Ativar Compacta√ß√£o no Traefik

```bash
traefik:
  command:
    - "--entrypoints.websecure.http.middlewares=compress@docker"
    - "--experimental.plugins.compress.modulename=github.com/klauspost/compress"
```
> Ganho: Reduz Data Transfer em ~50%.

## 4. Limitar Evolution API

```bash
evolution:
  environment:
    # Desabilitar logs verbosos
    - LOG_LEVEL=ERROR
    - LOG_BAILEYS=false
    
    # Limitar cache Redis
    - CACHE_TTL=3600  # 1 hora
    
    # N√£o salvar mensagens antigas
    - DATABASE_SAVE_MESSAGE_UPDATE=false
    - DATABASE_SAVE_OLD_MESSAGE=false
```
> Ganho: Menos I/O no banco, menos RAM consumida.

- Use as otimiza√ß√µes acima para evitar surpresas
- Monitore custos semanalmente com AWS Cost Explorer
- Evite processar v√≠deos no N8N (use Lambda para isso)
- Delete m√≠dias antigas do S3 mensalmente

## 5. Configurar Alertas de Custo

```bash
# Criar alerta no AWS Budgets
aws budgets create-budget \
  --account-id $(aws sts get-caller-identity --query Account --output text) \
  --budget '{
    "BudgetName": "AlobExpressAlert",
    "BudgetLimit": {"Amount": "10", "Unit": "USD"},
    "TimeUnit": "MONTHLY",
    "BudgetType": "COST"
  }' \
  --notifications-with-subscribers '[{
    "Notification": {
      "NotificationType": "ACTUAL",
      "ComparisonOperator": "GREATER_THAN",
      "Threshold": 80
    },
    "Subscribers": [{
      "SubscriptionType": "EMAIL",
      "Address": "seu@email.com"
    }]
  }]'
```

# üß™ Teste Completo de Upload/Download

## 1. Criar arquivo de teste:
   
```bash
echo "AlobExpress funcionando!" > teste.txt
```

## 2. Upload para S3:

```bash
aws s3 cp teste.txt s3://alobexpress-storage-2025/teste.txt
# upload: ./teste.txt to s3://alobexpress-storage-2025/teste.txt
```

## 3. Listar arquivos:

```bash
aws s3 ls s3://alobexpress-storage-2025/
# 2025-01-15 14:23:10         25 teste.txt
```

## 4. Download do S3:
   
```bash
aws s3 cp s3://alobexpress-storage-2025/teste.txt baixado.txt
# download: s3://alobexpress-storage-2025/teste.txt to ./baixado.txt
```

## 1. Verificar conte√∫do:

```bash
cat baixado.txt
# AlobExpress funcionando!
```

## 6. Deletar arquivo de teste:
   
```bash
aws s3 rm s3://alobexpress-storage-2025/teste.txt
# delete: s3://alobexpress-storage-2025/teste.txt
```

# üîÑ Atualizar o .env do Projeto

Se J√Å rodou o script:

```bash
cd /home/ubuntu/alobexpress
nano .env
```

Procure as linhas do S3 e atualize:

```bash
# === AWS S3 (Backups) ===
AWS_ACCESS_KEY_ID=AKIA...                    # Sua Access Key
AWS_SECRET_ACCESS_KEY=wJalr...               # Seu Secret
S3_REGION=us-east-1
S3_BUCKET_NAME=alobexpress-storage-2025      # Nome do SEU bucket
```

## Reiniciar os servi√ßos:

```bash
docker compose down
docker compose up -d
```


# üéØ Verificar se Evolution API Est√° Usando S3

```bash
docker compose logs -f evolution
```

Deve aparecer algo como:

```bash
[S3] Connected successfully to bucket: alobexpress-storage-2025
[S3] Region: us-east-1
```

## 2. Criar inst√¢ncia WhatsApp de teste:

Acesse: https://evolution.seudominio.com.br/manager
Crie uma inst√¢ncia e envie uma imagem via WhatsApp.

## 3. Verificar se foi para o S3:

```bash
aws s3 ls s3://alobexpress-storage-2025/evolution/ --recursive

# Deve aparecer algo como:
# 2025-01-15 15:10:23   145678 evolution/instance-teste/media/IMG-20250115-WA0001.jpg
```

> Se aparecer arquivos = S3 funcionando perfeitamente!

# üõ°Ô∏è Configurar CORS (para Evolution API)

Via Console:

1. Aba **Permissions ‚Üí CORS**
2. Clique **Edit**
3. Cole a configura√ß√£o:

```bash
[
  {
    "AllowedHeaders": [
      "*"
    ],
    "AllowedMethods": [
      "GET",
      "PUT",
      "POST",
      "DELETE",
      "HEAD"
    ],
    "AllowedOrigins": [
      "https://evolution.seudominio.com.br",
      "https://n8n.seudominio.com.br"
    ],
    "ExposeHeaders": [
      "ETag",
      "x-amz-request-id"
    ],
    "MaxAgeSeconds": 3600
  }
]
```
>  Substitua evolution.seudominio.com.br pelos seus dom√≠nios reais!

# üöÄ Viabilidade para N8N em Produ√ß√£o

## voc√™ consegue operar em produ√ß√£o! Mas com ressalvas:


### Cen√°rio Otimista (uso moderado):

50-100 workflows ativos
5.000-10.000 execu√ß√µes/dia
Webhooks leves (WhatsApp, HTTP)
Automa√ß√µes de resposta r√°pida

Dura√ß√£o: ‚úÖ Facilmente 17+ meses

### Cen√°rio Realista (uso intenso):

200+ workflows
20.000+ execu√ß√µes/dia
Processamento de imagens/v√≠deos
Integra√ß√µes pesadas (Google Sheets, Airtable)
M√∫ltiplas inst√¢ncias WhatsApp no Evolution

### Problemas esperados:

RAM insuficiente (2GB √© apertado)
CPU Credits esgotados (t3.small fica lento)
S3 crescendo (m√≠dias WhatsApp)
Swap constante (degrada performance)

Dura√ß√£o: ‚ö†Ô∏è 12-15 meses (com otimiza√ß√µes)


### **Op√ß√£o 3: Usar Oracle Cloud Free Tier**

```bash
4 vCPUs ARM, 24GB RAM, 200GB storage = GR√ÅTIS SEMPRE
```



# üö® Problemas Comuns

## Erro: "Unable to locate credentials"

```bash
# Reconfigurar
aws configure
```

```bash
# Verificar se salvou
cat ~/.aws/credentials
```

## Erro: "Access Denied"

```bash
# Verificar permiss√µes do usu√°rio IAM
aws iam get-user-policy --user-name alobexpress-s3-user --policy-name AlobExpressS3Policy
```

Se n√£o aparecer nada, volte no console AWS e vincule a policy novamente.

## Erro: "Bucket does not exist"


```bash
# Listar buckets dispon√≠veis
aws s3 ls

# Se n√£o aparecer, verifique se criou na regi√£o correta:
aws s3api get-bucket-location --bucket alobexpress-storage-2025
```

---

## üìù **Resumo do Fluxo**
```
1. ‚úÖ Conectar na EC2 (SSH)
2. ‚úÖ Instalar AWS CLI (apt install awscli)
3. ‚úÖ Configurar credenciais (aws configure)
4. ‚úÖ Criar estrutura de pastas (aws s3api put-object)
5. ‚úÖ Testar upload/download
6. ‚úÖ Atualizar .env com credenciais S3
7. ‚úÖ Rodar/reiniciar docker compose
8. ‚úÖ Verificar logs da Evolution API


